<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/main}">
	<head>
		<title th:text="${pageTitle} + ' | Smart Room'">Dashboard | Smart Room</title>

		<!-- CSS cho Dashboard -->
		<th:block layout:fragment="extra-css">
			<!-- DataTables CSS -->
			<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css" />

			<!-- Daterangepicker CSS -->
			<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

			<!-- Bootstrap Icons -->
			<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.min.css" />

			<style>
				/* Ẩn card biểu đồ và bộ lọc ban đầu */
				#chart-analysis-section {
					display: none;
				}
				/* Đảm bảo các biểu đồ con có chiều cao */
				.chart-container {
					position: relative;
					height: 250px;
					width: 100%;
					margin-bottom: 20px;
				}

				/* Fix checkbox alignment in DataTables */
				table.dataTable thead th input[type='checkbox'],
				table.dataTable thead th .form-check-input {
					position: static !important;
					margin: 0 auto !important;
					transform: none !important;
					display: block;
				}

				table.dataTable thead th.checkbox-column {
					width: 40px;
					text-align: center;
				}
			</style>
		</th:block>
	</head>

	<body>
		<section layout:fragment="content">
			<!-- Breadcrumb -->
			<div class="app-content-header">
				<div class="container-fluid">
					<div class="row">
						<div class="col-sm-6">
							<h3 class="mb-0" th:text="${pageTitle}">Dashboard</h3>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-end">
								<li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
								<li class="breadcrumb-item active" aria-current="page" th:text="${pageTitle}">Dashboard</li>
							</ol>
						</div>
					</div>
				</div>
			</div>

			<!-- Main Content -->
			<div class="app-content">
				<div class="container-fluid">
					<!-- Statistics Cards (SSR) -->
					<div class="row mb-3">
						<div class="col-lg-3 col-6">
							<div class="small-box bg-info stats-card">
								<div class="inner">
									<h3 th:text="${totalDevices}">0</h3>
									<p>Total Devices</p>
								</div>
								<div class="icon">
									<i class="fas fa-microchip"></i>
								</div>
							</div>
						</div>

						<div class="col-lg-3 col-6">
							<div class="small-box bg-success stats-card">
								<div class="inner">
									<h3 th:text="${onlineDevices}">0</h3>
									<p>Online Devices</p>
								</div>
								<div class="icon">
									<i class="fas fa-plug"></i>
								</div>
							</div>
						</div>

						<div class="col-lg-3 col-6">
							<div class="small-box bg-warning stats-card">
								<div class="inner">
									<h3 th:text="${totalSensors}">0</h3>
									<p>Total Sensors</p>
								</div>
								<div class="icon">
									<i class="fas fa-thermometer-half"></i>
								</div>
							</div>
						</div>

						<div class="col-lg-3 col-6">
							<div class="small-box bg-danger stats-card">
								<div class="inner">
									<h3 th:text="${totalAvgWattHour} + ' Wh'">0 Wh</h3>
									<p>Avg. Power Consumption</p>
								</div>
								<div class="icon">
									<i class="fas fa-bolt"></i>
								</div>
							</div>
						</div>
					</div>

					<!-- Device List Table (SSR with Thymeleaf) -->
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">Danh Sách Thiết Bị</h3>
								</div>
								<div class="card-body">
									<table id="deviceTable" class="table table-bordered table-hover dataTable" style="width: 100%">
										<thead>
											<tr>
												<th>Tên Thiết Bị</th>
												<th>Tên Phòng</th>
												<th>Tầng</th>
												<th>Wh Trung Bình</th>
												<th>Trạng Thái</th>
												<th class="text-center checkbox-column" style="width: 32px">
													<input type="checkbox" class="form-check-input" id="select-all" />
												</th>
											</tr>
										</thead>
										<tbody>
											<!-- SSR: Initial data from server -->
											<tr th:each="device : ${devices}" th:data-device-id="${device.id}">
												<td th:text="${device.name}">Device Name</td>
												<td th:text="${device.roomName != null ? device.roomName : 'N/A'}">Room Name</td>
												<td th:text="${device.floorLevel != null ? device.floorLevel : 'N/A'}">Floor</td>
												<td>
													<span th:if="${device.avgWattHour != null}" th:text="${#numbers.formatDecimal(device.avgWattHour, 0, 2)}">0.00</span>
													<span th:if="${device.avgWattHour != null}"> Wh</span>
													<span th:if="${device.avgWattHour == null}">N/A</span>
												</td>
												<td>
													<th:block th:replace="~{components/status-badge :: status-badge(status=${device.status}, text=${device.status})}"></th:block>
												</td>
												<td class="text-center">
													<input type="checkbox" class="form-check-input row-checkbox" />
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>

					<!-- Draw Chart Button -->
					<div class="row mt-3">
						<div class="col-12 d-flex align-items-center">
							<button id="show-chart-btn" class="btn btn-primary">
								<i class="bi bi-graph-up me-2"></i>
								Vẽ Biểu Đồ
							</button>
							<span id="selected-count-span" class="ms-3 text-muted fw-bold"> Số thiết bị đã chọn: 0 </span>
						</div>
					</div>

					<!-- Chart Section (Hidden by default, shown by JavaScript) -->
					<div class="row mt-3" id="chart-analysis-section">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">Dữ Liệu Cảm Biến</h3>
									<div class="card-tools">
										<!-- Date Range Filter -->
										<div id="reportrange-container" style="display: inline-block">
											<input
												type="text"
												id="date-filter-input"
												class="form-control"
												style="width: 280px"
												th:attr="data-start=${defaultStartTime}, data-end=${defaultEndTime}"
											/>
										</div>
									</div>
								</div>
								<div class="card-body">
									<!-- Separate charts for each metric -->

									<h5>Nhiệt độ (Temperature °C)</h5>
									<div class="chart-container">
										<canvas id="sensorChartTemp"></canvas>
									</div>

									<h5>Công suất (Watt)</h5>
									<div class="chart-container">
										<canvas id="sensorChartWatt"></canvas>
									</div>

									<h5>Điện áp (Volt)</h5>
									<div class="chart-container">
										<canvas id="sensorChartVolt"></canvas>
									</div>

									<h5>Dòng điện (Ampe)</h5>
									<div class="chart-container">
										<canvas id="sensorChartAmpe"></canvas>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- JavaScript -->
		<th:block layout:fragment="extra-js">
			<!-- DataTables -->
			<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
			<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>

			<!-- Moment.js (for Daterangepicker) -->
			<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>

			<!-- Daterangepicker -->
			<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

			<!-- Chart.js -->
			<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

			<!-- date-fns adapter for Chart.js -->
			<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
			<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.1/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

			<!-- Dashboard Application Script -->
			<script th:src="@{/js/dashboard.js}"></script>

			<!-- Pass server data to JavaScript -->
			<script th:inline="javascript">
				/*<![CDATA[*/
				// Global configuration from server
				window.DASHBOARD_CONFIG = {
					langCode: /*[[${langCode}]]*/ 'vi',
					defaultStartTime: /*[[${defaultStartTime}]]*/ null,
					defaultEndTime: /*[[${defaultEndTime}]]*/ null,
					devices: /*[[${devices}]]*/ [],
				};
				/*]]>*/
			</script>
		</th:block>
	</body>
</html>
